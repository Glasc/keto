---
import { useSanityClient } from "astro-sanity";
import Layout from "../../layouts/Layout.astro";
import { toPlainTextAndSummarized, transformDate } from "../../utils";

export type Post = {
  _id: string;
  publishedAt: string;
  text: any;
  title: string;
};

export async function getCategories(): Promise<Post[]> {
  try {
    const query = `*[_type == "post"]{
  _id,
  publishedAt,
  text,
  title,
}`;
    const listOfPosts = await useSanityClient().fetch(query);

    console.log(typeof listOfPosts[0].publishedAt);

    const listOfPostWithTransformedData = listOfPosts?.map((post: Post) => {
      return { ...post, publishedAt: transformDate(post.publishedAt) };
    });

    return listOfPostWithTransformedData;
  } catch (err) {
    console.log("Oops!");
    return [];
  }
}

const posts = await getCategories();

// <PortableText value={post.text} />
---

<Layout title="Blog">
  <main class="max-w-[60rem] mx-auto px-6 pt-6 pb-10 flex flex-col">
    <h1 class="font-bold text-4xl text-center text-neutral-content">
      Blog
    </h1>

    <section class="space-y-6 py-8 block mx-auto">
      {
        posts?.map((post) => {
          return (
            <a class="block hover:no-underline" href={`/blog/${post._id}`}>
              <article class="bg-base-100 hover:ring-secondary grid max-w-sm cursor-pointer grid-cols-1 items-start space-x-3 rounded-md ring-1 shadow-sm ring-slate-900/5 transition duration-300 ease-in-out hover:shadow-lg hover:ring-2 md:max-w-full md:grid-cols-[30%_1fr]">
                <img
                  class="w-ful self-center rounded-md"
                  src="/assets/products.jpg"
                  alt=""
                />
                <section class="p-4">
                  <div class="flex items-center justify-between">
                    <h2 class="text-neutral-content mt-2 mb-1 text-xl font-semibold">
                      {post.title}
                    </h2>
                    <p class="text-base-content ml-2">{post.publishedAt}</p>
                  </div>
                  <div class="xd mt-3 ">
                    {toPlainTextAndSummarized(post.text, 25)}
                  </div>
                </section>
              </article>
            </a>
          );
        })
      }
    </section>

    <div class="flex justify-center">
      <div class="btn-group">
        <button class="btn bg-primary text-primary-content">«</button>
        <button class="btn bg-primary text-primary-content">Page 1</button>
        <button class="btn bg-primary text-primary-content">»</button>
      </div>
    </div>
  </main>
</Layout>
